#! env make

ifeq ($(type), header-only)
	TARGET = header
else ifeq ($(type), static)
	TARGET = $(PROJECT_ROOT)/build/libgalotfa.a
else ifeq ($(type), shared)
	TARGET = $(PROJECT_ROOT)/build/libgalotfa.so
else ifeq ($(type), all)
	TARGET = $(PROJECT_ROOT)/build/libgalotfa.so $(PROJECT_ROOT)/build/libgalotfa.a
else
	type = unknown
endif


$(PROJECT_ROOT)/build/libgalotfa.a: src/*/*.*
	@mkdir -p $(BUILD_DIR)/include $(BUILD_DIR)/lib
	@cp -r $(PROJECT_ROOT)/src/* $(BUILD_DIR)/include/
	$(MPICXX) $(CXXFLAGS) -c $(PROJECT_ROOT)/src/galotfa.cpp -o $(BUILD_DIR)/galotfa.o
	ar -rcs $(BUILD_DIR)/lib/libgalotfa.a -lhdf5 -lgsl -lgslcblas $(BUILD_DIR)/galotfa.o
	@rm $(BUILD_DIR)/galotfa.o
	@rm $(BUILD_DIR)/include/**/*.c*


$(PROJECT_ROOT)/build/libgalotfa.so: src/*/*.*
	@mkdir -p $(BUILD_DIR)/include $(BUILD_DIR)/lib
	@cp -r $(PROJECT_ROOT)/src/* $(BUILD_DIR)/include/
	$(MPICXX) $(CXXFLAGS) --shared -fPIC $(PROJECT_ROOT)/src/galotfa.cpp -lhdf5 -lgsl -lgslcblas -o $(BUILD_DIR)/lib/libgalotfa.so
	@rm $(BUILD_DIR)/include/**/*.c*


header:
	@echo "Copying header files ..."
	@cp -r $(PROJECT_ROOT)/src/* $(BUILD_DIR)/include/
	@sed -i "1i #define header_only" $(BUILD_DIR)/include/galotfa.h

.PHONY: header
